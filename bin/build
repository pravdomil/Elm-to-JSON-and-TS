#!/usr/bin/env bash

# To stop if any command fails.
set -e

# To stop on unset variables.
set -u

# To be in project root.
cd "${0%/*}/.."

# To compile our app.
elm make src/Main.elm --output bin/elm-json-interop.js --optimize
(
  echo "#!/usr/bin/env node"
  sed -E "/^.*jsCode\('/s/\\\'/'/g;s/^.*jsCode\('(.*)'));$/_Scheduler_binding(function(callback) { try { callback(_Scheduler_succeed(\1)) } catch (e) { callback( _Scheduler_fail(String(e))) } }));/g" bin/elm-json-interop.js
  echo ";this.Elm.Main.init();"
) >bin/elm-json-interop
rm bin/elm-json-interop.js
chmod +x bin/elm-json-interop

# To build example.
bin/elm-json-interop example/src/Example.elm
elm-format --yes example/src/Generated/*.elm
