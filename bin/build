#!/usr/bin/env bash

# To stop if any command fails.
set -e

# To stop on unset variables.
set -u

# To be in project root.
cd "${0%/*}/.."

# To compile our app.
elm make src/Main.elm --output bin/elm-to-json-and-ts.js --optimize
gsed -i -E \
  "             1s/^/#!\/usr\/bin\/env node\n/
   /^.*jsCode\('/s/\\\'/'/g
                 s/^.*jsCode\('(.*)'\)/_Scheduler_binding(async (callback) => { try { callback(_Scheduler_succeed(await \1)) } catch (e) { callback( _Scheduler_fail(String(e))) } })/g
               \$s/$/\nthis.Elm.Main.init();/" \
  bin/elm-to-json-and-ts.js
mv bin/elm-to-json-and-ts.js bin/elm-to-json-and-ts
chmod +x bin/elm-to-json-and-ts

# To build example.
bin/elm-to-json-and-ts example/src/Example.elm
elm-format --yes example/src/Generated/Example/*.elm
